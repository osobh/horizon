//! Test template operations in synthesis
//!
//! RED phase - create failing tests

use cudarc::driver::CudaContext;
use gpu_agents::synthesis::template_ops::{
    CompositeTemplate, TemplateCondition, TemplateEngine, TemplateFunction, TemplateLoop,
    TemplateVariable,
};
use std::collections::HashMap;

// Helper macro for creating hashmaps
macro_rules! hashmap {
    ($($key:expr => $value:expr),*) => {{
        let mut map = HashMap::new();
        $(map.insert($key.to_string(), $value.to_string());)*
        map
    }};
}

fn main() -> anyhow::Result<()> {
    println!("Testing Template Operations in Synthesis (RED phase)");
    println!("=================================================");

    let ctx = CudaContext::new(0)?;

    // Test 1: Create template engine
    println!("\n1. Testing template engine creation...");
    let engine = TemplateEngine::new(ctx.clone())?;
    println!("❌ TemplateEngine created but needs implementation");

    // Test 2: Variable substitution
    println!("\n2. Testing variable substitution...");
    let mut variables = HashMap::new();
    variables.insert("name".to_string(), "Alice".to_string());
    variables.insert("age".to_string(), "30".to_string());

    let template = "Hello {{name}}, you are {{age}} years old.";
    let result = engine.substitute_variables(template, &variables)?;
    println!(
        "❌ Expected: 'Hello Alice, you are 30 years old.' Got: '{}'",
        result
    );
    assert_eq!(result, "Hello Alice, you are 30 years old.");

    // Test 3: Conditional templates
    println!("\n3. Testing conditional templates...");
    let condition = TemplateCondition::new("has_gpu", true);
    let if_template = "GPU acceleration enabled";
    let else_template = "Running on CPU";

    let result = engine.evaluate_condition(&condition, if_template, else_template)?;
    println!("❌ Expected: 'GPU acceleration enabled' Got: '{}'", result);
    assert_eq!(result, "GPU acceleration enabled");

    // Test 4: Loop templates
    println!("\n4. Testing loop templates...");
    let items = vec!["apple", "banana", "orange"];
    let loop_template = TemplateLoop::new("fruits", items);
    let item_template = "- {{item}}";

    let result = engine.expand_loop(&loop_template, item_template)?;
    println!("❌ Expected loop expansion, Got: '{}'", result);
    assert!(result.contains("apple"));

    // Test 5: Template functions
    println!("\n5. Testing template functions...");
    let function = TemplateFunction::new("uppercase", |s: &str| s.to_uppercase());
    engine.register_function(function)?;

    let template = "{{uppercase(name)}}";
    let result = engine.apply_functions(template, &variables)?;
    println!("❌ Expected: 'ALICE' Got: '{}'", result);
    assert_eq!(result, "ALICE");

    // Test 6: Composite templates
    println!("\n6. Testing composite templates...");
    let mut comp_vars = HashMap::new();
    comp_vars.insert("title".to_string(), "Test Document".to_string());
    comp_vars.insert("content".to_string(), "This is the content".to_string());
    comp_vars.insert("generator".to_string(), "TemplateEngine".to_string());

    let composite = CompositeTemplate::new()
        .add_template("header", "# {{title}}")
        .add_template("body", "{{content}}")
        .add_template("footer", "---\nGenerated by {{generator}}");

    let result = engine.render_composite(&composite, &comp_vars)?;
    println!("❌ Expected composite rendering, Got: '{}'", result);
    assert!(result.contains("Test Document"));

    // Test 7: GPU-accelerated template expansion
    println!("\n7. Testing GPU-accelerated template expansion...");
    let templates = vec!["Hello {{name}}", "Welcome {{user}}", "Goodbye {{person}}"];
    let batch_vars = vec![
        hashmap! {"name" => "Alice"},
        hashmap! {"user" => "Bob"},
        hashmap! {"person" => "Charlie"},
    ];

    let results = engine.gpu_batch_expand(&templates, &batch_vars)?;
    println!("❌ Expected 3 results, Got: {}", results.len());
    assert_eq!(results.len(), 3);

    Ok(())
}
