name: Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC to catch any quality regressions
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  quality-enforcement:
    name: Enforce Quality Standards
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for comparisons

    - name: Checkout hpc-channels dependency
      uses: actions/checkout@v4
      with:
        repository: rustyhpc/hpc-channels
        path: 02-hpc-channels

    - name: Checkout warp dependency
      uses: actions/checkout@v4
      with:
        repository: rustyhpc/warp
        path: 05-warp

    - name: Create symlinks for path dependencies
      run: |
        ln -s $GITHUB_WORKSPACE/02-hpc-channels $GITHUB_WORKSPACE/../02-hpc-channels
        ln -s $GITHUB_WORKSPACE/05-warp $GITHUB_WORKSPACE/../05-warp

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check for NEW unwrap() calls
      id: unwrap_check
      run: |
        echo "üîç Checking for new unwrap() calls..."
        
        # Get the base branch for comparison
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
        else
          BASE_SHA="HEAD~1"
        fi
        
        # Count unwrap() calls in current branch
        CURRENT_UNWRAPS=$(find . -name "*.rs" -not -path "./target/*" -not -path "./tests/*" -not -path "./benches/*" -exec grep -c "\.unwrap()" {} + | awk '{sum+=$1} END {print sum}')
        echo "Current unwrap() count: $CURRENT_UNWRAPS"
        
        # Count unwrap() calls in base branch
        git checkout $BASE_SHA 2>/dev/null || true
        BASE_UNWRAPS=$(find . -name "*.rs" -not -path "./target/*" -not -path "./tests/*" -not -path "./benches/*" -exec grep -c "\.unwrap()" {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')
        echo "Base unwrap() count: $BASE_UNWRAPS"
        
        # Switch back to current branch
        git checkout - 2>/dev/null || true
        
        # Calculate difference
        UNWRAP_DIFF=$((CURRENT_UNWRAPS - BASE_UNWRAPS))
        
        if [ "$UNWRAP_DIFF" -gt 0 ]; then
          echo "‚ùå Error: Added $UNWRAP_DIFF new unwrap() calls"
          echo "::error::Added $UNWRAP_DIFF new unwrap() calls. Use ? operator instead."
          exit 1
        elif [ "$UNWRAP_DIFF" -lt 0 ]; then
          echo "‚úÖ Great! Removed $((-UNWRAP_DIFF)) unwrap() calls"
        else
          echo "‚úÖ No new unwrap() calls added"
        fi
    
    - name: Check for todo!() macros
      run: |
        echo "üîç Checking for todo!() macros..."
        
        TODO_COUNT=$(find . -name "*.rs" -not -path "./target/*" -exec grep -c "todo!()" {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')
        
        if [ "$TODO_COUNT" -gt 0 ]; then
          echo "‚ùå Error: Found $TODO_COUNT todo!() macros"
          echo "::error::Found $TODO_COUNT todo!() macros. Complete implementations before merging."
          find . -name "*.rs" -not -path "./target/*" -exec grep -l "todo!()" {} + | head -10
          exit 1
        else
          echo "‚úÖ No todo!() macros found"
        fi
    
    - name: Check for unimplemented!() macros
      run: |
        echo "üîç Checking for unimplemented!() macros..."
        
        UNIMPL_COUNT=$(find . -name "*.rs" -not -path "./target/*" -exec grep -c "unimplemented!()" {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')
        
        if [ "$UNIMPL_COUNT" -gt 0 ]; then
          echo "‚ùå Error: Found $UNIMPL_COUNT unimplemented!() macros"
          echo "::error::Found $UNIMPL_COUNT unimplemented!() macros. Complete implementations before merging."
          exit 1
        else
          echo "‚úÖ No unimplemented!() macros found"
        fi
    
    - name: Check file sizes
      run: |
        echo "üîç Checking file sizes..."
        
        LARGE_FILES=$(find . -name "*.rs" -not -path "./target/*" -exec wc -l {} + | awk '$1 > 850 {print $2 " (" $1 " lines)"}')
        
        if [ -n "$LARGE_FILES" ]; then
          echo "‚ö†Ô∏è Warning: Files exceeding 850 lines:"
          echo "$LARGE_FILES" | head -10
          echo "::warning::Large files detected. Consider splitting files >850 lines."
        else
          echo "‚úÖ All files under 850 lines"
        fi
    
    - name: Check code formatting
      run: |
        echo "üîç Checking code formatting..."
        cargo fmt --all -- --check
    
    - name: Run Clippy lints
      run: |
        echo "üîç Running Clippy checks..."
        cargo clippy --all-targets --all-features -- \
          -D warnings \
          -D clippy::unwrap_used \
          -D clippy::expect_used \
          -D clippy::panic \
          -D clippy::unimplemented \
          -D clippy::todo
    
    - name: Generate quality report
      if: always()
      run: |
        echo "üìä Generating quality report..."
        python3 scripts/quality_dashboard.py > quality_report.txt
        cat quality_report.txt
    
    - name: Upload quality report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: quality-report
        path: quality_report.txt
    
    - name: Comment PR with quality metrics
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('quality_report.txt', 'utf8');
          
          // Extract key metrics from report
          const unwrapMatch = report.match(/unwrap\(\) calls:\s+(\d+)/);
          const todoMatch = report.match(/todo!\(\) macros:\s+(\d+)/);
          const scoreMatch = report.match(/Overall Quality Score[^0-9]+(\d+)/);
          
          const unwraps = unwrapMatch ? unwrapMatch[1] : 'Unknown';
          const todos = todoMatch ? todoMatch[1] : 'Unknown';
          const score = scoreMatch ? scoreMatch[1] : 'Unknown';
          
          const comment = `## üìä Quality Check Results
          
          | Metric | Value | Status |
          |--------|-------|--------|
          | unwrap() calls | ${unwraps} | ${unwraps === '0' ? '‚úÖ' : '‚ö†Ô∏è'} |
          | todo!() macros | ${todos} | ${todos === '0' ? '‚úÖ' : '‚ùå'} |
          | Quality Score | ${score}/100 | ${score >= 80 ? '‚úÖ' : score >= 60 ? '‚ö†Ô∏è' : '‚ùå'} |
          
          <details>
          <summary>Full Quality Report</summary>
          
          \`\`\`
          ${report}
          \`\`\`
          </details>
          
          ---
          *See [CONTRIBUTING.md](../blob/main/CONTRIBUTING.md) for quality guidelines.*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  test-coverage:
    name: Test Coverage Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Checkout hpc-channels dependency
      uses: actions/checkout@v4
      with:
        repository: rustyhpc/hpc-channels
        path: 02-hpc-channels

    - name: Checkout warp dependency
      uses: actions/checkout@v4
      with:
        repository: rustyhpc/warp
        path: 05-warp

    - name: Create symlinks for path dependencies
      run: |
        ln -s $GITHUB_WORKSPACE/02-hpc-channels $GITHUB_WORKSPACE/../02-hpc-channels
        ln -s $GITHUB_WORKSPACE/05-warp $GITHUB_WORKSPACE/../05-warp

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Install tarpaulin
      run: cargo install cargo-tarpaulin
    
    - name: Generate test coverage
      run: |
        cargo tarpaulin --all-features --workspace --timeout 300 --out Xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./cobertura.xml
        fail_ci_if_error: false
        verbose: true
    
    - name: Check coverage threshold
      run: |
        # Extract coverage percentage
        COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' cobertura.xml | head -1)
        COVERAGE_PCT=$(echo "$COVERAGE * 100" | bc -l | cut -d. -f1)
        
        echo "Test coverage: ${COVERAGE_PCT}%"
        
        if [ "$COVERAGE_PCT" -lt "80" ]; then
          echo "::warning::Test coverage is below 80% threshold"
        fi

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Checkout hpc-channels dependency
      uses: actions/checkout@v4
      with:
        repository: rustyhpc/hpc-channels
        path: 02-hpc-channels

    - name: Checkout warp dependency
      uses: actions/checkout@v4
      with:
        repository: rustyhpc/warp
        path: 05-warp

    - name: Create symlinks for path dependencies
      run: |
        ln -s $GITHUB_WORKSPACE/02-hpc-channels $GITHUB_WORKSPACE/../02-hpc-channels
        ln -s $GITHUB_WORKSPACE/05-warp $GITHUB_WORKSPACE/../05-warp

    - name: Run cargo audit
      run: |
        cargo install cargo-audit
        cargo audit

  performance-check:
    name: Performance Regression Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Checkout hpc-channels dependency
      uses: actions/checkout@v4
      with:
        repository: rustyhpc/hpc-channels
        path: 02-hpc-channels

    - name: Checkout warp dependency
      uses: actions/checkout@v4
      with:
        repository: rustyhpc/warp
        path: 05-warp

    - name: Create symlinks for path dependencies
      run: |
        ln -s $GITHUB_WORKSPACE/02-hpc-channels $GITHUB_WORKSPACE/../02-hpc-channels
        ln -s $GITHUB_WORKSPACE/05-warp $GITHUB_WORKSPACE/../05-warp

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Run benchmarks
      run: |
        echo "üöÄ Running performance benchmarks..."
        cargo bench --no-fail-fast | tee benchmark_results.txt
    
    - name: Check for performance regressions
      run: |
        # This would compare against baseline benchmarks
        # For now, just ensure benchmarks compile and run
        echo "‚úÖ Benchmarks completed successfully"
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark_results.txt